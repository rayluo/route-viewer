<!DOCTYPE html>
<!-- Derived from:
* Mapbox GL example https://www.mapbox.com/help/getting-started-directions-api/#review-the-response
* Mapbox js example https://www.mapbox.com/mapbox.js/example/v1.0.0/single-marker/
* Mapbox js line example https://www.mapbox.com/help/extending-interactivity/#next-steps
-->
<html>
<head>
<meta charset=utf-8 />
<title>A simple map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
<script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.6/papaparse.min.js"></script>
<script src="https://zenozeng.github.io/color-hash/dist/color-hash.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>

<div id='map'>
  <li><a href="?start_lat=40.733&start_lon=-73.989&end_lat=40.733&end_lon=-74">Example with input in url</a></li>
  <li><a href="?solution_url=solution.csv">Example with input in a csv file</a></li>
</div>
<script>
function getRoute(access_token, start_lat, start_lon, end_lat, end_lon, callback) {
  var routeUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${start_lon}%2C${start_lat}%3B${end_lon}%2C${end_lat}.json?access_token=${access_token}&steps=true&geometries=geojson`;
  jQuery.getJSON(routeUrl, function(data){callback(data.routes[0].geometry)})
  .fail(function( jqxhr, textStatus, error ) {
    console.log( "Request Failed: " + textStatus + ", " + error );
  });
}

L.mapbox.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejh2N21nMzAxMmQzMnA5emRyN2lucW0ifQ.jSE-g2vsn48Ry928pqylcg'; // A sample key came from mapbox's own online example

var qp = new URLSearchParams(window.location.search);
if(qp.has("start_lat") && qp.has("start_lon") && qp.has("end_lat") && qp.has("end_lon")) {
  var map = L.mapbox.map('map', 'mapbox.streets');
  getRoute(
    L.mapbox.accessToken, qp.get("start_lat"), qp.get("start_lon"),
    qp.get("end_lat"), qp.get("end_lon"), function(geojson) {
      L.mapbox.featureLayer(geojson).addTo(map);
    }
  );
  map.setView([qp.get("start_lat"), qp.get("start_lon")], 14);
}
else if(qp.has("solution_url")) {
  // Here we consume a csv file with headers as: veh_id, origin_lat, origin_lon,
  // destination_lat, destination_lon, etc..
  jQuery.get(qp.get("solution_url"), function(csv){
    var solution = Papa.parse(csv, {header: true});
    if(solution.errors) {  // Malformed CSV, such as the trailing empty line.
      solution.errors.forEach(function(error){
        console.log(error);
      });
    }
    if(solution.data) {
      var map = L.mapbox.map('map', 'mapbox.streets');
      var colorHash = new ColorHash();
      solution.data.forEach(function(leg){
        if(leg.veh_id){  // This also filters out the final empty line
          getRoute(
            L.mapbox.accessToken, leg.origin_lat, leg.origin_lon,
            leg.destination_lat, leg.destination_lon, function(geometry) {
              var properties = {
                "stroke": colorHash.hex(leg.veh_id),
                "stroke-opacity": 1,
                "stroke-width": 4
              };
              var geojson = {type: 'Feature', geometry: geometry, properties: properties};
              L.mapbox.featureLayer(geojson).addTo(map);
            }
          );
          map.setView([leg.origin_lat, leg.origin_lon], 14);
        }
      });
    }
  })
  .fail(function( jqxhr, textStatus, error ) {
    console.log( "Request Failed: " + textStatus + ", " + error );
  });
}
else console.log("No param recognized");

</script>

</body>
</html>
